<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThreeDotts Persistent Widget</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent;
            overflow: hidden;
            pointer-events: none;
        }
        
        /* Only allow pointer events on the widget itself */
        #threedotts-widget {
            pointer-events: auto;
        }
    </style>
</head>
<body>
    <script>
        console.log('üöÄ [PERSISTENT WIDGET] Starting persistent widget...');
        
        // Configuration from localStorage or URL params
        let organizationId = localStorage.getItem('threedotts_org_id');
        
        if (!organizationId) {
            const urlParams = new URLSearchParams(window.location.search);
            organizationId = urlParams.get('organizationId');
            if (organizationId) {
                localStorage.setItem('threedotts_org_id', organizationId);
            }
        }
        
        console.log('üîç [PERSISTENT WIDGET] Organization ID:', organizationId);
        
        if (organizationId) {
            console.log('üöÄ [PERSISTENT WIDGET] Loading widget script...');
            
            // Load the widget script
            const script = document.createElement('script');
            script.src = `https://dkqzzypemdewomxrjftv.supabase.co/functions/v1/widget-script?organizationId=${organizationId}&v=62`;
            script.onerror = (error) => {
                console.error('‚ùå [PERSISTENT WIDGET] Failed to load widget script:', error);
            };
            
            script.onload = () => {
                console.log('‚úÖ [PERSISTENT WIDGET] Widget script loaded successfully');
                
                // Define client tools globally
                window.redirectToExternalURL = (parameters) => {
                    console.log('üîó [PERSISTENT WIDGET] redirectToExternalURL called with:', parameters);
                    
                    const url = parameters?.url;
                    if (url) {
                        console.log('üîó [PERSISTENT WIDGET] Processing redirect to:', url);
                        
                        if (url.startsWith('http')) {
                            console.log('üåê [PERSISTENT WIDGET] Sending openExternalURL message to parent');
                            parent.postMessage({
                                type: 'openExternalURL',
                                url: url
                            }, '*');
                            console.log('‚úÖ [PERSISTENT WIDGET] External URL message sent to parent');
                            return `Opened ${url} in new tab`;
                        } else {
                            console.log('üìç [PERSISTENT WIDGET] Sending navigate message to parent');
                            parent.postMessage({
                                type: 'navigate',
                                url: url
                            }, '*');
                            console.log('‚úÖ [PERSISTENT WIDGET] Navigate message sent to parent');
                            return `Redirected to ${url}`;
                        }
                    } else {
                        console.error('‚ùå [PERSISTENT WIDGET] No URL provided to redirectToExternalURL');
                        throw new Error('URL parameter is required');
                    }
                };
                
                console.log('üîß [PERSISTENT WIDGET] Client tools registered, configuring widget...');
                
                // Configure widget when loaded
                setTimeout(() => {
                    console.log('üîç [PERSISTENT WIDGET] Checking for threedottsWidget...');
                    console.log('üîç [PERSISTENT WIDGET] window.threedottsWidget exists:', !!window.threedottsWidget);
                    
                    if (window.threedottsWidget) {
                        console.log('‚úÖ [PERSISTENT WIDGET] Widget found, configuring with organizationId');
                        window.threedottsWidget.configure({
                            organizationId: organizationId
                        });
                        console.log('‚úÖ [PERSISTENT WIDGET] Widget configured with organizationId:', organizationId);
                        
                        // Save widget state for persistence across page reloads
                        const saveWidgetState = () => {
                            if (window.threedottsWidget && window.threedottsWidget.isConnected) {
                                localStorage.setItem('threedotts_connected', 'true');
                                localStorage.setItem('threedotts_connection_time', Date.now().toString());
                            }
                        };
                        
                        // Listen for widget state changes
                        const originalOnConnectionChange = window.threedottsWidget.onConnectionChange;
                        window.threedottsWidget.onConnectionChange = (connected) => {
                            if (originalOnConnectionChange) originalOnConnectionChange(connected);
                            if (connected) {
                                localStorage.setItem('threedotts_connected', 'true');
                                localStorage.setItem('threedotts_connection_time', Date.now().toString());
                                console.log('üíæ [PERSISTENT WIDGET] Connection state saved');
                            } else {
                                localStorage.removeItem('threedotts_connected');
                                localStorage.removeItem('threedotts_connection_time');
                                console.log('üóëÔ∏è [PERSISTENT WIDGET] Connection state cleared');
                            }
                        };
                        
                        // Check if we should attempt to reconnect quickly
                        const wasConnected = localStorage.getItem('threedotts_connected');
                        const connectionTime = localStorage.getItem('threedotts_connection_time');
                        
                        if (wasConnected === 'true' && connectionTime) {
                            const timeSinceConnection = Date.now() - parseInt(connectionTime);
                            // If connected recently (within 30 seconds), consider it a page navigation
                            if (timeSinceConnection < 30000) {
                                console.log('üîÑ [PERSISTENT WIDGET] Recent connection detected, this looks like a page navigation');
                            }
                        }
                        
                    } else {
                        console.error('‚ùå [PERSISTENT WIDGET] Widget not found after loading script');
                    }
                }, 100);
            };
            
            document.head.appendChild(script);
            console.log('üìÑ [PERSISTENT WIDGET] Script element added to head');
        } else {
            console.error('‚ùå [PERSISTENT WIDGET] No organizationId available');
        }

        // Listen for messages from parent window
        window.addEventListener('message', (event) => {
            console.log('üì® [PERSISTENT WIDGET] Received message from parent:', event.data);
            
            // Handle commands from parent if needed
            if (event.data.type === 'ping') {
                parent.postMessage({ type: 'pong', timestamp: Date.now() }, '*');
            }
        });
        
        // Notify parent that widget is ready
        setTimeout(() => {
            parent.postMessage({ type: 'widgetReady', timestamp: Date.now() }, '*');
            console.log('üì° [PERSISTENT WIDGET] Sent ready signal to parent');
        }, 500);
        
        console.log('üéØ [PERSISTENT WIDGET] Persistent widget initialization complete');
    </script>
</body>
</html>