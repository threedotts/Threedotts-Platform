<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThreeDotts Widget</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent;
            overflow: hidden;
            pointer-events: none;
        }
        
        /* Only allow pointer events on the widget itself */
        #threedotts-widget {
            pointer-events: auto;
        }
    </style>
</head>
<body>
    <script>
        // Get organizationId from URL params
        const urlParams = new URLSearchParams(window.location.search);
        const organizationId = urlParams.get('organizationId');
        
        if (organizationId) {
            // Load the widget script with the organizationId
            const script = document.createElement('script');
            script.src = `https://dkqzzypemdewomxrjftv.supabase.co/functions/v1/widget-script?organizationId=${organizationId}&v=60`;
            script.onerror = (error) => {
                console.error('❌ Failed to load widget script:', error);
            };
            
            script.onload = () => {
                console.log('✅ Widget script loaded successfully in iframe');
                
                // Define client tools globally on window (same as before)
                window.redirectToExternalURL = (parameters) => {
                    const url = parameters?.url;
                    if (url) {
                        console.log('🔗 Redirecting to:', url);
                        // For iframe, we need to communicate with parent window
                        if (url.startsWith('http')) {
                            // Send message to parent to open in new tab
                            parent.postMessage({
                                type: 'openExternalURL',
                                url: url
                            }, '*');
                            return `Opened ${url} in new tab`;
                        } else {
                            // Send message to parent to navigate
                            parent.postMessage({
                                type: 'navigate',
                                url: url
                            }, '*');
                            return `Redirected to ${url}`;
                        }
                    } else {
                        throw new Error('URL parameter is required');
                    }
                };
                
                // Configure widget when loaded
                setTimeout(() => {
                    if (window.threedottsWidget) {
                        window.threedottsWidget.configure({
                            organizationId: organizationId
                        });
                        console.log('✅ Widget configured with organizationId!');
                    } else {
                        console.error('❌ Widget not found after loading script');
                    }
                }, 100);
            };
            
            document.head.appendChild(script);
        } else {
            console.error('❌ No organizationId provided to widget iframe');
        }

        // Listen for messages from parent window (for future communication if needed)
        window.addEventListener('message', (event) => {
            // Handle any messages from parent if needed
            console.log('Iframe received message:', event.data);
        });
    </script>
</body>
</html>